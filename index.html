<!DOCTYPE html>
<style>
:root {
  color-scheme: light dark;
}
body {
  color: light-dark(#333b3c, #efefec);
  background-color: light-dark(#efefec, #333b3c);
}
.cf:before,
.cf:after {
  content: " ";
  display: table;
}
.cf:after { clear: both; }
</style>
<head>
    <link rel="icon" href="media/icon.png">
</head>
<body>
    <div id="roomBox" style="text-align: center;"></div>
    <div class="wrapper cf">
        <div id="messageBox" style="height: 500px; width: 500px; border: 3px solid light-dark(#333b3c, #efefec); overflow-y: scroll; margin-right: 36.71%; float: right;"></div>
    </div>
    <div style="margin: auto; text-align: center;">
        <p style="display: inline;" ><input id="messageInput" maxlength="999" pattern="[ -~]+" minlength="1"></p>
        <p id="messageInputLength" style="display: inline;">(999)</p>
    </div>
    <br>
</body>
<script>
const input = document.getElementById("messageInput");
const messageBox = document.getElementById("messageBox");
const inputLength = document.getElementById("messageInputLength");

// constant HTML elements that are commonly used
const base = `https://classdb.it.mtu.edu/~zrlatuse${window.location.pathname.includes("/public/") ? "/public" : ""}`;
const params = window.location.search;

let allMessages = {}; // all currently stored messages. Format is {roomId: [msg, msg]...}
let currentRoomId = null;
let allRooms = [];
let heartbeats = {}; // stores which roomIds have connections to server to listen for message updates. stored as {roomId: bool} where bool is true if a connection is active, false otherwise
const username = localStorage.getItem("username");
let userId = -1;
let allUsers = {}; // all users

const logout = function() {
    navigator.sendBeacon(`${base}/api/changeStatus.php`, JSON.stringify({"authorId": userId, "status": "OFFLINE"}));
}

if (username == null) { // if user gets to this page without a username redirect them to login
    window.location.href = `${base}/login.html${params}`;
}

fetch(`${base}/api/login.php`, { // verifies current username is valid and gets userId which is needed to send messages
    method: "POST",
    headers: {
        "Content-Type": "application/json",
    },
    body: JSON.stringify({"username": username})
}).then(async (resp) => {
    const results = await resp.json();
    if (results.success) { // if login is good then build page
        userId = results.id;
        
        
        fetch(`${base}/api/changeStatus.php`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({"authorId": userId, "status": "ONLINE"})
        }).then((resp) => {
            fetch(`${base}/api/getAllUsers.php`, {
                method: "GET"
            }).then(async (resp) => {
                (await resp.json()).forEach((user) => {
                    if (!allUsers.hasOwnProperty(user["status"])) {
                        allUsers[user["status"]] = [];
                    }
                    allUsers[user["status"]].push(user)
                })
                fetch(`${base}/api/getAllRooms.php`, { // get all rooms
                    method: "GET"
                }).then(async (resp) => {
                    allRooms = await resp.json();
                    allRooms.forEach((room) => { // builds the global variables needed for this to function
                        allMessages[room.roomId] = []
                        heartbeats[room.roomId] = false;
                    });
                    buildRoomBox();
                    switchRoom(1); // switches room to the default channel 1
                });
            });
        });
    } else { // otherwise remove the username and redirect to logout
        localStorage.removeItem("username");
        window.location.href = `${base}/login.html${params}`;
    }
});

const createRoomElement = function(room) { // takes in a room object from DB and turns it into a formatted HTML object which it returns
    const button = document.createElement("button");
    button.innerText = room.name;
    button.id = `roomButton-${room.roomId}`;
    button.onclick = function() {
        switchRoom(room.roomId);
    };
    return button;
}

const buildRoomBox = function() { // replaces the roomBox's children with a new set of children from the allRooms object, NOTE that it does not remember if any button was disabled
    roomBox.replaceChildren(...allRooms.map((room) => {
        return createRoomElement(room);
    }));
}

const createMessageElement = function(msg) { // takes in a message object from DB and turns it into a formatted HTML object which it returns
    const div = document.createElement("div");
    const timestamp = document.createElement("p");
    timestamp.style = "font-size: x-small;position: relative;margin-bottom: 0px;margin-left: 5px;";
    timestamp.innerText = msg.timestamp;
    const message = document.createElement("p");
    message.style = "margin-top: 0px;margin-left: 5px;";
    message.innerText = `${msg.name} said: ${msg.message}`;
    div.replaceChildren(timestamp, message);
    return div;
}

const buildMessageBox = function() { // replaces messageBox's children with a new set of children of the currentRoomId and also sets scroll to be the bottom
    messageBox.replaceChildren(...allMessages[currentRoomId].map((msg) => {
        return createMessageElement(msg);
    }));
    messageBox.scrollTop = messageBox.scrollHeight;
}

const heartbeat = function(roomId) { // listens to a given roomId for new messages until the currentRoomId does not match its given roomId it will then terminate itself
    fetch(`${base}/api/getNewMessages.php`, { // gets all new messages after the last message in that room or a default date if that room is empty
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            "lastTimestamp": allMessages[roomId].length === 0 ? "2024-10-09 12:00:00" : allMessages[roomId][allMessages[roomId].length - 1]["timestamp"],
            "roomId": roomId,
        })
    }).then(async (resp) => {
        if (resp.status === 504) { // connection was open too long and now is displaying an error. This simply means no new messages have been added so the server holds on to the connection
            console.log("504 being handled, ignore the error above"); // handled the same as if there was a response recieved
            if (roomId === currentRoomId) {
                heartbeat(roomId);
            } else {
                heartbeats[roomId] = false;
            }
        } else {
            const newMessages = await resp.json();
            allMessages[roomId].push(...newMessages); // adds new messages to the roomId it was assigned
            if (roomId === currentRoomId) { // if the roomId it was assigned is the currentRoomId then update the messageBox and start the cycle again
                newMessages.forEach(msg => {
                    messageBox.appendChild(createMessageElement(msg));
                });
                messageBox.scrollTop = messageBox.scrollHeight;
                heartbeat(roomId);
            } else { // otherwise terminate self
                heartbeats[roomId] = false;
            }
        }
    });
}

const switchRoom = function(newRoomId) { // allows switching current active room
    currentRoomId = newRoomId; // swaps global var to be the newRoomId
    if (!heartbeats[currentRoomId]) { // if there is not already a listener for that room, then update `heartbeats` to say that there is and then create one
        heartbeats[currentRoomId] = true;
        heartbeat(currentRoomId);
    }
    document.getElementById(`roomButton-${newRoomId}`).disabled = true; // set new room button to be not active
    buildMessageBox(); // build a new message box and clear previous one
}

input.onkeydown = async function(ev) {
    if (ev.key === "Enter" && userId > 0) {
        if (input.validity.valid) {
            const res = await fetch(`${base}/api/newMessage.php`, { // TODO: add error handling here
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({"message": input.value, "roomId": currentRoomId, "authorId": userId}) // sends data to server to add new row to message table
            });
            input.value = "";
        } else {
            alert("Message is invalid");
        }
    } else {
        inputLength.innerText = `(${999 - input.value.length})`;
    }
}
input.onkeyup = function(ev) {
    inputLength.innerText = `(${999 - input.value.length})`;
}


window.addEventListener("beforeunload", logout);

</script>